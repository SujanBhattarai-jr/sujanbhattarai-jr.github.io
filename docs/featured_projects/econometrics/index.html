<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sujan Bhattarai">

<title>Did Smoking Mothers Have Lowered Weight Children?</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../pic.jpg" rel="icon" type="image/jpeg">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<link rel="stylesheet" href="../../featured_style_projects.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../featured_projects.html" rel="" target="">
 <span class="menu-text">DS-projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html" rel="" target="">
 <span class="menu-text">Analytics-projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../certifications.html" rel="" target="">
 <span class="menu-text">Certificates</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Did Smoking Mothers Have Lowered Weight Children?</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Statistics</div>
    <div class="quarto-category">Econometrics</div>
    <div class="quarto-category">Causal Inference</div>
    <div class="quarto-category">R</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Sujan Bhattarai </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="summary-and-conclusion" class="level3">
<h3 class="anchored" data-anchor-id="summary-and-conclusion">Summary and Conclusion</h3>
<p>The analysis aimed to estimate the causal effect of maternal smoking during pregnancy on infant birth weight. Initial comparisons showed a significant difference in birth weights between infants of smoking and non-smoking mothers. However, confounding variables suggested that the groups were not comparable.</p>
<p>Propensity score matching was applied to address these confounders. Post-matching tests indicated successful balancing of the treatment and control groups. The final analysis showed that maternal smoking causally reduces infant birth weight by an average of 13 grams, after accounting for confounding variables. This result highlights the importance of proper matching techniques in observational studies to draw valid causal inferences</p>
</section>
<section id="project-begins" class="level3">
<h3 class="anchored" data-anchor-id="project-begins">Project Begins:</h3>
<p>The goal is to estimate the causal effect of maternal smoking during pregnancy on infant birth weight using the treatment ignorability assumptions. The data are taken from the National Natality Detail Files, and the extract “SMOKING_EDS241.csv”’ is a random sample of all births in Pennsylvania during 1989-1991. Each observation is a mother-infant pair. The key variables are:</p>
<p><strong>The outcome and treatment variables are:</strong></p>
<p>birthwgt=birth weight of infant in grams</p>
<p>tobacco=indicator for maternal smoking</p>
<p><strong>The control variables are:</strong></p>
<p>mage (mother’s age), meduc (mother’s education), mblack (=1 if mother identifies as Black), alcohol (=1 if consumed alcohol during pregnancy), first (=1 if first child), diabete (=1 if mother diabetic), anemia (=1 if mother anemic)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stargazer)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plm)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pglm)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RItools)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(estimatr)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Hmisc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>smoking_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">"featured_projects/econometrics/data/SMOKING_EDS241.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="mean-differences-assumptions-and-covariates" class="level4">
<h4 class="anchored" data-anchor-id="mean-differences-assumptions-and-covariates">Mean Differences, Assumptions, and Covariates</h4>
<p>For conducting t-test, it is important to have population divided into treatment and control group. Since this experiment already has that information, I can segregate them into two tables and perform t-tests.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">## calculating difference using t.test when tobacco is 1 and 0</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>smoking_mothers <span class="ot">=</span> smoking_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(tobacco <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>non_smoking_mothers <span class="ot">=</span> smoking_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(tobacco <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">#peform t-test to see if the difference is significant in other covariates</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(smoking_mothers<span class="sc">$</span>birthwgt, non_smoking_mothers<span class="sc">$</span>birthwgt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Welch Two Sample t-test

data:  smoking_mothers$birthwgt and non_smoking_mothers$birthwgt
t = -58.932, df = 26945, p-value &lt; 2.2e-16
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 -252.6727 -236.4060
sample estimates:
mean of x mean of y 
 3185.747  3430.286 </code></pre>
</div>
</div>
<p>The mean difference is 244.539 grams between children from smoker and non-smoker mothers, which is significant at 5%. The assumptions for this mean difference to hold are ignorability (no other confounding variables influencing the outcome) and common support (there is sufficient overlap between the treatment and control group). If these assumptions are satisfied, I can infer the difference is actually due to smoking and not due to random chance.</p>
<p>I can test those assumptions with t-tests for numeric covariates, and proportion test for categorical covariates The following code achives that:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#set options to have maximum 5 decimal</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">digits=</span><span class="dv">5</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="do">## For continuous variables I can use the t-test</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">#t.test()</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>education <span class="ot">&lt;-</span> <span class="fu">t.test</span>(smoking_mothers<span class="sc">$</span>meduc, non_smoking_mothers<span class="sc">$</span>meduc)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> <span class="fu">t.test</span>(smoking_mothers<span class="sc">$</span>mage, non_smoking_mothers<span class="sc">$</span>mage)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>birthwht <span class="ot">&lt;-</span> <span class="fu">t.test</span>(smoking_mothers<span class="sc">$</span>birthwgt, non_smoking_mothers<span class="sc">$</span>birthwgt)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="do">## For binary variables I should use the proportions test</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">#prop.test()</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>alcohol <span class="ot">&lt;-</span> <span class="fu">prop.test</span>(<span class="fu">table</span>(smoking_mothers<span class="sc">$</span>alcohol), <span class="fu">table</span>(non_smoking_mothers<span class="sc">$</span>alcohol))</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>first_child <span class="ot">&lt;-</span><span class="fu">prop.test</span>(<span class="fu">table</span>(smoking_mothers<span class="sc">$</span>first), <span class="fu">table</span>(non_smoking_mothers<span class="sc">$</span>first))</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>diabetes<span class="ot">&lt;-</span> <span class="fu">prop.test</span>(<span class="fu">table</span>(smoking_mothers<span class="sc">$</span>diabete), <span class="fu">table</span>(non_smoking_mothers<span class="sc">$</span>diabete))</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>anaemia <span class="ot">&lt;-</span> <span class="fu">prop.test</span>(<span class="fu">table</span>(smoking_mothers<span class="sc">$</span>anemia),  <span class="fu">table</span>(non_smoking_mothers<span class="sc">$</span>anemia))</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>black   <span class="ot">&lt;-</span> <span class="fu">prop.test</span>(<span class="fu">table</span>(smoking_mothers<span class="sc">$</span>mblack),  <span class="fu">table</span>(non_smoking_mothers<span class="sc">$</span>mblack))</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------- Covariate Calculations and Tables</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co"># create dataframe of coefficents from above results including</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co"># first column should be variable name, then mean of estimate for sample 1, then</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co"># mean of sample 2, then p values </span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>table <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">"birthweight"</span>, <span class="st">"education"</span>, <span class="st">"age"</span>, <span class="st">"alcohol"</span>, <span class="st">"first_child"</span>, <span class="st">"diabetes"</span>, <span class="st">"anaemia"</span>, <span class="st">"black"</span>),</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">smoking_mothers =</span> <span class="fu">c</span>(birthwht<span class="sc">$</span>estimate[<span class="dv">1</span>], education<span class="sc">$</span>estimate[<span class="dv">1</span>], age<span class="sc">$</span>estimate[<span class="dv">1</span>], </span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">sum</span>(smoking_mothers<span class="sc">$</span>alcohol)<span class="sc">/</span><span class="fu">length</span>(smoking_mothers<span class="sc">$</span>alcohol),  </span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">sum</span>(smoking_mothers<span class="sc">$</span>first)<span class="sc">/</span><span class="fu">length</span>(smoking_mothers<span class="sc">$</span>first), </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">sum</span>(smoking_mothers<span class="sc">$</span>diabete)<span class="sc">/</span><span class="fu">length</span>(smoking_mothers<span class="sc">$</span>diabete), </span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">sum</span>(smoking_mothers<span class="sc">$</span>anemia)<span class="sc">/</span><span class="fu">length</span>(smoking_mothers<span class="sc">$</span>anemia), </span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">sum</span>(smoking_mothers<span class="sc">$</span>mblack)<span class="sc">/</span><span class="fu">length</span>(smoking_mothers<span class="sc">$</span>mblack)),</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">non_smoking_mothers =</span> <span class="fu">c</span>(birthwht<span class="sc">$</span>estimate[<span class="dv">2</span>], education<span class="sc">$</span>estimate[<span class="dv">2</span>], age<span class="sc">$</span>estimate[<span class="dv">2</span>], </span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">sum</span>(non_smoking_mothers<span class="sc">$</span>alcohol)<span class="sc">/</span><span class="fu">length</span>(non_smoking_mothers<span class="sc">$</span>alcohol),</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">sum</span>(non_smoking_mothers<span class="sc">$</span>first)<span class="sc">/</span><span class="fu">length</span>(non_smoking_mothers<span class="sc">$</span>first),</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">sum</span>(non_smoking_mothers<span class="sc">$</span>diabete)<span class="sc">/</span><span class="fu">length</span>(non_smoking_mothers<span class="sc">$</span>diabete), </span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">sum</span>(non_smoking_mothers<span class="sc">$</span>anemia)<span class="sc">/</span><span class="fu">length</span>(non_smoking_mothers<span class="sc">$</span>anemia), </span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">sum</span>(non_smoking_mothers<span class="sc">$</span>mblack)<span class="sc">/</span><span class="fu">length</span>(non_smoking_mothers<span class="sc">$</span>mblack)),</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_value =</span> <span class="fu">round</span>(<span class="fu">c</span>(birthwht<span class="sc">$</span>p.value, </span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>                    education<span class="sc">$</span>p.value, </span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>                    age<span class="sc">$</span>p.value, </span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>                    alcohol<span class="sc">$</span>p.value, </span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>                    first_child<span class="sc">$</span>p.value, </span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>                    diabetes<span class="sc">$</span>p.value, </span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>                    anaemia<span class="sc">$</span>p.value, </span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>                    black<span class="sc">$</span>p.value), <span class="dv">6</span>))</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     variable smoking_mothers non_smoking_mothers p_value
1 birthweight      3.1857e+03          3.4303e+03       0
2   education      1.1921e+01          1.3239e+01       0
3         age      2.5539e+01          2.7453e+01       0
4     alcohol      4.4182e-02          7.1033e-03       0
5 first_child      3.6459e-01          4.3609e-01       0
6    diabetes      1.7519e-02          1.7364e-02       0
7     anaemia      1.4103e-02          7.8005e-03       0
8       black      1.3541e-01          1.0863e-01       0</code></pre>
</div>
</div>
<p><strong>Interpretation</strong>: The result shows that the population sample on treated and control group is dissimilar. The p values are less than .05, which means alternative hypothesis shoule be accepted. Alternative hypothesis for this test is: there is difference between treated and control group.</p>
<p>So far, I know there is already a difference in the two samples. But we can still quantify how much these covariates influence these biased samples. The following chunk will do that by calculating average treatment effects with a regression model for these biased groups.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ATE Regression univariate</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>tobacco_univariate <span class="ot">&lt;-</span> <span class="fu">lm</span>(birthwgt <span class="sc">~</span> tobacco, <span class="at">data =</span> smoking_data)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ATE with covariates</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>tobacco_covariates <span class="ot">&lt;-</span> <span class="fu">lm</span>(birthwgt <span class="sc">~</span>  tobacco <span class="sc">+</span> mage <span class="sc">+</span>  meduc <span class="sc">+</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                           mblack <span class="sc">+</span> alcohol <span class="sc">+</span> first <span class="sc">+</span> diabete <span class="sc">+</span> anemia, </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> smoking_data)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="do">## create combined table</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="fu">stargazer</span>(tobacco_univariate, tobacco_covariates, <span class="at">type =</span> <span class="st">"text"</span>, </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">out.header =</span> <span class="cn">TRUE</span>, </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">title =</span> <span class="st">"Regression with and without controls"</span>,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">notes.label =</span> <span class="st">"significance level"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Regression with and without controls
===========================================================================
                                      Dependent variable:                  
                    -------------------------------------------------------
                                           birthwgt                        
                                (1)                         (2)            
---------------------------------------------------------------------------
tobacco                     -244.540***                 -228.070***        
                              (4.079)                     (4.177)          
                                                                           
mage                                                      -0.694*          
                                                          (0.357)          
                                                                           
meduc                                                    11.688***         
                                                          (0.860)          
                                                                           
mblack                                                  -240.030***        
                                                          (5.106)          
                                                                           
alcohol                                                  -77.350***        
                                                          (13.465)         
                                                                           
first                                                    -96.944***        
                                                          (3.447)          
                                                                           
diabete                                                  73.228***         
                                                          (12.104)         
                                                                           
anemia                                                     -4.796          
                                                          (16.754)         
                                                                           
Constant                    3,430.300***                3,362.300***       
                              (1.791)                     (11.927)         
                                                                           
---------------------------------------------------------------------------
Observations                   94,173                      94,173          
R2                             0.037                       0.072           
Adjusted R2                    0.037                       0.072           
Residual Std. Error     493.750 (df = 94171)        484.730 (df = 94164)   
F Statistic         3,594.300*** (df = 1; 94171) 909.180*** (df = 8; 94164)
===========================================================================
significance level                              *p&lt;0.1; **p&lt;0.05; ***p&lt;0.01</code></pre>
</div>
</div>
<p>If I have to see the result above, seems like all covariates are responsible for change in birthweights in the smoking and non smoking mothers. But since the treated and control groups are dissimilar, it should not be inferred that these covariates are producing change.</p>
<p>I can do one more test before I process the data to make them true. I can test if any of the covariates have a similar population between the treated and control groups already. I can use chi-squared tests among all these variables to see which one truly represents a similar population being compared.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># perform balance test</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">xBalance</span>(tobacco <span class="sc">~</span> mage <span class="sc">+</span>  meduc <span class="sc">+</span> mblack <span class="sc">+</span> alcohol <span class="sc">+</span> first <span class="sc">+</span> diabete <span class="sc">+</span> anemia <span class="sc">+</span> birthwgt,  <span class="at">data =</span> smoking_data,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">report=</span><span class="fu">c</span>(<span class="st">"std.diffs"</span>,<span class="st">"chisquare.test"</span>, <span class="st">"p.values"</span>))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">#use staragazer to present the results</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(x[<span class="dv">1</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>   <span class="co">#round last column to 5 digit</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.numeric, round, <span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#rename columns based on number index</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>( <span class="st">"chi-Square/standard difference test"</span>, <span class="st">"p-value"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         chi-Square/standard difference test p-value
mage                                -0.36194  0.0000
meduc                               -0.64374  0.0000
mblack                               0.08439  0.0000
alcohol                              0.31525  0.0000
first                               -0.14500  0.0000
diabete                              0.00119  0.8858
anemia                               0.06670  0.0000
birthwgt                            -0.49527  0.0000</code></pre>
</div>
</div>
<p>Only the diabetic covariate is similar between sample group at this point. What this means is that the population samples between treatment and control group are similar only in regards to diabetes.</p>
<p>Lets also calculate propensity estimation for this biased sample:</p>
</section>
<section id="propensity-score-estimation-for-the-biased-treated-and-control-groups" class="level4">
<h4 class="anchored" data-anchor-id="propensity-score-estimation-for-the-biased-treated-and-control-groups">Propensity Score Estimation for the biased Treated and control Groups</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Propensity Scores estimation with logistic regression</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>mother_prospensityscore <span class="ot">&lt;-</span> <span class="fu">glm</span>(tobacco <span class="sc">~</span>  mage <span class="sc">+</span>  meduc <span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                           mblack <span class="sc">+</span> alcohol <span class="sc">+</span> first <span class="sc">+</span> diabete <span class="sc">+</span> anemia <span class="sc">+</span> birthwgt, <span class="at">data =</span> smoking_data,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">family =</span> <span class="fu">binomial</span>())</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="do">## create a table of coefficients</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>stargazer<span class="sc">::</span> <span class="fu">stargazer</span>(mother_prospensityscore, <span class="at">type =</span> <span class="st">"text"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=============================================
                      Dependent variable:    
                  ---------------------------
                            tobacco          
---------------------------------------------
mage                       -0.040***         
                            (0.002)          
                                             
meduc                      -0.288***         
                            (0.005)          
                                             
mblack                     -0.361***         
                            (0.028)          
                                             
alcohol                    1.962***          
                            (0.062)          
                                             
first                      -0.460***         
                            (0.020)          
                                             
diabete                    0.229***          
                            (0.067)          
                                             
anemia                     0.333***          
                            (0.081)          
                                             
birthwgt                   -0.001***         
                           (0.00002)         
                                             
Constant                   6.456***          
                            (0.090)          
                                             
---------------------------------------------
Observations                94,173           
Log Likelihood            -40,841.000        
Akaike Inf. Crit.         81,699.000         
=============================================
Note:             *p&lt;0.1; **p&lt;0.05; ***p&lt;0.01</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#create regression table dataframe based on mother_prospensityscore</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming you have a regression model object named 'model'</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># You would need to replace 'model' with the actual name of your model object</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> mother_prospensityscore</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract coefficients, standard errors, and p-values from the model</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>coefficients <span class="ot">&lt;-</span> <span class="fu">coef</span>(model)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>standard_errors <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcov</span>(model)))</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>p_values <span class="ot">&lt;-</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients[, <span class="dv">4</span>]  <span class="co"># Extracting p-values</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Define function to determine significance level</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>get_significance_level <span class="ot">&lt;-</span> <span class="cf">function</span>(p_value) {</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;</span> <span class="fl">0.01</span>) {</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">'***'</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (p_value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">'**'</span>)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (p_value <span class="sc">&lt;</span> <span class="fl">0.1</span>) {</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">'*'</span>)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">''</span>)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Get significance levels</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>significance_levels <span class="ot">&lt;-</span> <span class="fu">sapply</span>(p_values, get_significance_level)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dataframe</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">Coefficient =</span> coefficients,</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">Standard_error =</span> <span class="fu">round</span>(standard_errors, <span class="dv">3</span>),</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">Significance_level =</span> significance_levels</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the dataframe</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Coefficient Standard_error Significance_level
(Intercept)  6.45614093          0.090                ***
mage        -0.04012754          0.002                ***
meduc       -0.28772570          0.005                ***
mblack      -0.36100043          0.028                ***
alcohol      1.96216177          0.062                ***
first       -0.45972476          0.020                ***
diabete      0.22927944          0.067                ***
anemia       0.33284394          0.081                ***
birthwgt    -0.00091614          0.000                ***</code></pre>
</div>
</div>
<p><em>The covariates coefficients are strengths/weights of each variables that determines whether a unit will recieve the treatment. For example, the coefficient of mother’s age is 0.04, which means that for every unit increase in mother’s age, keeping all other covariates constant, the log odds of being in treatment group decreases by 0.02. This is statistically significant as evident by p value, which is much less than 0.05. All covariates in the model are significant which means they are all important in determining the treatment status for a unit X.</em></p>
<p><em>Among all covariates, alcohol has the greatest influence on whether a unit will recieve treatment, followed by first born child, which negative influence in being treatment group. These coefficients are all significant at 5% significance level.</em></p>
<p>In summary: what the above table is showing is that: all these covariates are responsible whether a unit falls into a treatment or control group. This is bad because an experiment should be completely random and should not influenced by anything. that means significance level for all those should have been more than 0.05.</p>
<p>Look at the side by side histogram below. That is asymmetric. It should be made symmetric. and then I can run all analysis again .</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="do">## use this logistic model to create a new column of prospensity scores for each observation</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>smoking_data<span class="sc">$</span>prospensity_scores <span class="ot">&lt;-</span> <span class="fu">predict</span>(mother_prospensityscore, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">#round the scores to 2 decimal places</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>smoking_data<span class="sc">$</span>prospensity_scores <span class="ot">&lt;-</span> <span class="fu">round</span>(smoking_data<span class="sc">$</span>prospensity_scores, <span class="dv">2</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Histogram of PS before matching</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="fu">histbackback</span>(<span class="fu">split</span>(smoking_data<span class="sc">$</span>prospensity_scores, smoking_data<span class="sc">$</span>tobacco),</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">main=</span> <span class="st">"Propensity score before matching"</span>,  </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">xlab=</span><span class="fu">c</span>(<span class="st">"control"</span>,  <span class="st">"treatment"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><em><strong>Overlap and its meaning</strong> Overlap refers to the degree of similarity or commonality between the treatment group (those who received the treatment being studied) and the control group (those who did not receive the treatment). The overlap is important because it is a necessary condition for the ignorability assumption to hold. If there is no overlap, then the treatment and control groups are so different that it is impossible to make causal inferences. The histogram above shows that there is a only some overlap between the treatment and control group, more individuals in the control group with lower propensity scores than in the treatment group. This is a violation of the Common Support assumption.</em></p>
<p><strong>Based on the analysis done so far. So, to resolve that I can select only those subjects that can create similarity in the samples.</strong></p>
<p>That will involve following steps:</p>
<p>-Calculate propensity score and match based on propensity values, then rerun all analysis as before. Propensity score calculates the probability that a unit will fall into treatment group.</p>
<p>*<strong>*Okay: lets begin the real analysis on unbiased data: The steps are:</strong></p>
<ul>
<li><p>match the population and rerun ATE</p></li>
<li><p>rerun average treatment effect on treated only</p></li>
<li><p>perform more analysis matching samples by neighbour method, inverse weighted method</p></li>
</ul>
</section>
<section id="step-1.-matching-the-population-with-propensity-score" class="level4">
<h4 class="anchored" data-anchor-id="step-1.-matching-the-population-with-propensity-score">STEP 1. Matching the population with propensity score</h4>
<p>Match treated/control mothers using your estimated propensity scores and nearest neighbor matching. Compare the balancing of pretreatment characteristics (covariates) between treated and non-treated units in the original dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Nearest-neighbor Matching</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>prospensity_score_matched <span class="ot">&lt;-</span> MatchIt<span class="sc">::</span><span class="fu">matchit</span>(tobacco <span class="sc">~</span>  mage <span class="sc">+</span>  meduc <span class="sc">+</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                             mblack <span class="sc">+</span> alcohol <span class="sc">+</span> first <span class="sc">+</span> diabete <span class="sc">+</span> anemia <span class="sc">+</span> birthwgt, <span class="at">data =</span> smoking_data, <span class="at">method =</span> <span class="st">"nearest"</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Covariate Imbalance post matching</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>matched_prospensity_dataset <span class="ot">&lt;-</span> <span class="fu">match.data</span>(prospensity_score_matched)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Drawing back to back histograms for propensity scores for treated and </span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co"># non-treated after matching</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="fu">histbackback</span>(<span class="fu">split</span>(matched_prospensity_dataset<span class="sc">$</span>prospensity_scores,  matched_prospensity_dataset<span class="sc">$</span>tobacco),   <span class="at">main=</span> <span class="st">"Propensity</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="st">        score   after   matching"</span>,  <span class="at">xlab=</span><span class="fu">c</span>(<span class="st">"control"</span>,   <span class="st">"treatment"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Post matching, there is a better overlap between the treatment and control group. Units with high propensity score is matched with its counterparts and vice versa. This means the units we are comparing between the treatment and control group are similar. This helps us define counterfactuals of what would have happened to the treatment group if they were not treated.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the covariates between treated and non-treated that were used in the</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># estimation of the propensity scores</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">xBalance</span>(tobacco <span class="sc">~</span> mage <span class="sc">+</span>  meduc <span class="sc">+</span> mblack <span class="sc">+</span> alcohol <span class="sc">+</span> first <span class="sc">+</span> diabete <span class="sc">+</span> anemia <span class="sc">+</span> birthwgt, <span class="at">data =</span> matched_prospensity_dataset,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">report=</span><span class="fu">c</span>(<span class="st">"std.diffs"</span>,<span class="st">"chisquare.test"</span>, <span class="st">"p.values"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         strata():  unstrat    
         stat      std.diff    
vars                           
mage                    0.0 ***
meduc                   0.0 ***
mblack                  0.0 ** 
alcohol                 0.1 ***
first                   0.0 ***
diabete                 0.0 .  
anemia                  0.0    
birthwgt                0.0 *  
---Overall Test---
        chisquare df p.value
unstrat       175  8   1e-33
---
Signif. codes:  0 '***' 0.001 '** ' 0.01 '*  ' 0.05 '.  ' 0.1 '   ' 1 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">xBalance</span>(tobacco <span class="sc">~</span> mage <span class="sc">+</span>  meduc <span class="sc">+</span> mblack <span class="sc">+</span> alcohol <span class="sc">+</span> first <span class="sc">+</span> diabete <span class="sc">+</span> anemia <span class="sc">+</span> birthwgt, <span class="at">data =</span> smoking_data,</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">report=</span><span class="fu">c</span>(<span class="st">"std.diffs"</span>,<span class="st">"chisquare.test"</span>, <span class="st">"p.values"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         strata():  unstrat     
         stat      std.diff     
vars                            
mage                   -0.4 *** 
meduc                  -0.6 *** 
mblack                  0.1 *** 
alcohol                 0.3 *** 
first                  -0.1 *** 
diabete                 0.0     
anemia                  0.1 *** 
birthwgt               -0.5 *** 
---Overall Test---
        chisquare df p.value
unstrat     10298  8       0
---
Signif. codes:  0 '***' 0.001 '** ' 0.01 '*  ' 0.05 '.  ' 0.1 '   ' 1 </code></pre>
</div>
</div>
<p>After the matching, the nature and weight of the regression coefficients changed. Previously in unmatched data, I discussed that with increase age of mother, propensity score decreases. But post matching, the coefficients is showing that propensity score actually increases with increasing age of the mother. This is a sign that matching have accounted fixed effects in the observational dataset. Moreover, some covariates which were significant in determining the treatement status in the pre matching, are not significant anymore post matching. Like diabete, anemia, birthwgt, and mblack. Thus mother being black, having diabetes, and having anaemia, does not determine if she will receive the treatment or not.</p>
<p><strong>But, this conclusion is not yet sufficient. What if I see this change only on treated population and not in control group ? The follwing step involves that:</strong></p>
</section>
<section id="step-2-average-treatment-effect-on-treated-group" class="level4">
<h4 class="anchored" data-anchor-id="step-2-average-treatment-effect-on-treated-group">STEP 2: Average treatment effect on treated group</h4>
<p>This step is necessary because it can be more robust estimate. For example: this will compare the change before treatment and after treatment in the same units.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate ATE based on nearest neighbor matching</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>sumdiff_data <span class="ot">&lt;-</span> matched_prospensity_dataset<span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(subclass)<span class="sc">%&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> birthwgt[tobacco<span class="sc">==</span><span class="dv">1</span>]<span class="sc">-</span> birthwgt[tobacco<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>dif_in_treated <span class="ot">&lt;-</span> <span class="fu">sum</span>(sumdiff_data<span class="sc">$</span>diff)<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>ATT_weighted_count <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">sum</span>(matched_prospensity_dataset<span class="sc">$</span>tobacco) <span class="sc">*</span> dif_in_treated</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>ATT_weighted_count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -13.361</code></pre>
</div>
</div>
<p>For the treated smoker mothers, the tobacco effects on their child birth weight is lower by 13 grams on average than for its counterfactual non smoking mothers. This means that the treatment has caused lower birth weight in the treated group of mothers. For any other units of population who shares similar covariates as treated group, the birth weight of their child will be lower by 13 grams on average if they were to start smoking tobacco.</p>
<p><strong>Is the conclusion final ? not yet. What if the propensity matching has drawbacks, which it does already. Propensity score matching is based on the fact that all covariates have similar influence in treatment. But, this does not always hold true. WLS matching fixes that.</strong></p>
</section>
<section id="ate-with-wls-matching" class="level4">
<h4 class="anchored" data-anchor-id="ate-with-wls-matching">ATE with WLS Matching</h4>
<p>This step is necessary becuase the</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Weighted least Squares (WLS) estimator Preparation</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>smoking_data <span class="ot">&lt;-</span> smoking_data <span class="sc">%&gt;%</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weights =</span> tobacco <span class="sc">/</span> prospensity_scores <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> tobacco) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> prospensity_scores))</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Weighted least Squares (WLS) Estimates</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>wls <span class="ot">&lt;-</span> <span class="fu">lm</span>(birthwgt <span class="sc">~</span> tobacco <span class="sc">+</span> mage <span class="sc">+</span>  meduc <span class="sc">+</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                           mblack <span class="sc">+</span> alcohol <span class="sc">+</span> first <span class="sc">+</span> diabete <span class="sc">+</span> anemia, </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> smoking_data, <span class="at">weights =</span> weights)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wls)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = birthwgt ~ tobacco + mage + meduc + mblack + alcohol + 
    first + diabete + anemia, data = smoking_data, weights = weights)

Weighted Residuals:
   Min     1Q Median     3Q    Max 
 -7283   -374     32    396  12243 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 3122.734     11.584  269.58  &lt; 2e-16 ***
tobacco        1.426      3.241    0.44     0.66    
mage           0.219      0.358    0.61     0.54    
meduc         23.497      0.881   26.69  &lt; 2e-16 ***
mblack      -215.695      4.978  -43.33  &lt; 2e-16 ***
alcohol     -174.499     13.803  -12.64  &lt; 2e-16 ***
first        -65.326      3.509  -18.61  &lt; 2e-16 ***
diabete       72.223     12.213    5.91  3.4e-09 ***
anemia       -23.746     16.766   -1.42     0.16    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 698 on 94163 degrees of freedom
  (1 observation deleted due to missingness)
Multiple R-squared:  0.0369,    Adjusted R-squared:  0.0368 
F-statistic:  451 on 8 and 94163 DF,  p-value: &lt;2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Present results</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>The WLS matching is weighted based on propensity scores, meaning unit with higher similarity in covariates gets more weights. Based on this matching, the average birth weight of children for non smoker mother or control group is 3122.7338, keeping all other variables unchanged. This is statistically significant at 5% signficance. Of all the covariates, mblack covariates has greatest influence in outcome. i.e If the women identifies as black, the birth weight of the child is lower by 241 grams, which is significant. Besides, other covariates like drinking alcohol, first born child, and diabetes in covariates also significantly influence birthweight. However, tobacco appears insignificant at 5 percent signficance level. The model only explains 3 percent of variation given by R squared in birth weight of children. This means that the model is not a good fit for the data.</em></p>
<p>There are certain factors that influences the output more than other covariates. This was also shown by the coefficients in Balance estimates in previous step. When using ATT with propensity score matching, the model assumed that all covariates has equal influence in determining the treatment status. But in reality, this is not always true. The WLS matching takes weights of each covariates into account, thus providing different output than ATT. if all the covariates had same weights, we would have got same estimate using both ATT and WLS matching.</p>
<p><strong>Is the conclusion final ?</strong></p>
<p><strong>-Statistically YES !</strong></p>
</section>
</section>
<section id="section" class="level3">
<h3 class="anchored" data-anchor-id="section"></h3>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Sujan-Bhattarai12">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 Copyright 2023, Sujan Bhattarai
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>